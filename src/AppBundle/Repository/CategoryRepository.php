<?php

namespace AppBundle\Repository;

use AppBundle\Entity\Category3;

/**
 * CategoryRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class CategoryRepository extends \Doctrine\ORM\EntityRepository {
    /**
     * @return array
     */
    public function getRoot() {
        return $this->createQueryBuilder( 'category' )
                    ->where( 'category.isActive = :status' )
                    ->andWhere( 'category.parent_category IS NULL' )
                    ->orderBy( 'category.id', 'DESC' )
                    ->setParameter( 'status', true )
                    ->getQuery()
                    ->getResult();
    }

    /**
     * Get catalog tree.
     *
     * @return array
     */
    public function getCatalogMenu() {
        $categories   = [ ];
        $dbCategories = $this->findBy( [ 'isActive' => true ], [ 'parent_category' => 'ASC', 'weight' => 'DESC' ] );
        if ( $dbCategories ) {
            foreach ( $dbCategories as $category ) {
                /** @var Category3 $category */
                $inner = [
                    'id'    => $category->getId(),
                    'title' => $category->getTitle(),
                    'slug'  => $category->getSlug(),
                ];

                $parent1 = $category->getParentCategory();
                $cause1  = $parent1 instanceof Category3 && $parent1->isIsActive();
                if ( $cause1 && ! $parent1->getParentCategory() ) {
                    $parentId = $category->getParentCategory()->getId();
                    if ( ! array_key_exists( $parentId, $categories ) ) {
                        $categories[ $parentId ]['children'] = [ ];
                    }

                    $categories[ $parentId ]['children'][ $category->getId() ]['id']    = $category->getId();
                    $categories[ $parentId ]['children'][ $category->getId() ]['title'] = $category->getTitle();
                    $categories[ $parentId ]['children'][ $category->getId() ]['slug']  = $category->getSlug();

                } else if ( $cause1 && $parent1->getParentCategory() instanceof Category3
                            && $parent1->getParentCategory()->isIsActive() && $parent1->getParentCategory()->getParentCategory() === null
                ) {
                    $parentParentId = $parent1->getParentCategory()->getId();
                    $parentId       = $category->getParentCategory()->getId();
                    if ( ! array_key_exists( $parentParentId, $categories ) ) {
                        $categories[ $parentParentId ]['children'] = [ ];
                    }
                    if ( ! array_key_exists( 'children', $categories[ $parentParentId ] ) ||
                         ! array_key_exists( $parentId, $categories[ $parentParentId ]['children'] )
                    ) {
                        $categories[ $parentParentId ]['children'][ $parentId ]['children'] = [ ];
                    }

                    $categories[ $parentParentId ]['children'][ $parentId ]['children'][ $category->getId() ]['id']    = $category->getId();
                    $categories[ $parentParentId ]['children'][ $parentId ]['children'][ $category->getId() ]['title'] = $category->getTitle();
                    $categories[ $parentParentId ]['children'][ $parentId ]['children'][ $category->getId() ]['slug']  = $category->getSlug();
                } else if ( $parent1 === null ) {
                    if ( array_key_exists( $category->getId(), $categories ) ) {
                        $categories[ $category->getId() ]['id']    = $inner['id'];
                        $categories[ $category->getId() ]['title'] = $inner['title'];
                        $categories[ $category->getId() ]['slug']  = $inner['slug'];
                    } else {
                        $categories[ $category->getId() ] = $inner;
                    }

                }
            }
        }

        return $categories;

    }
}
